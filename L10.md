# Sync 锁升级 - 偏向锁

## 使用的前提

1. 至少JDK1.6 并且开启了偏向锁的配置
   -XX：BiasedLoackingStartUpDelay = 0
   -XX:-UseBiasedLocking=false
2. 被加锁的对象，没有真正、或者隐式的调用父类Object 里面的hashcode方法
    - 一旦调用了object的hashcode方法，那么我们的对象头里面就有真正的hashcode了。
    - 如果偏向锁来进行markword的替换，至少要提供一个替换hashcode的方法，但是没有。因此升级为轻量级锁

为了让线程获得锁的代价更低而引入了偏向锁。当一个线程访问同步块并获取锁的时候，会在

`对象头`：`存储线程ID`

`栈帧中的锁记录`:`线程有自己的栈帧，LOCK RECORD->存储当前线程ID`

存储锁偏向的线程ID。以后该线程进入和退出同步块的时候不需要进行CAS操作来进行加锁和解锁，只需要简单地测试一下对象头的mark
word里是否存储着指向当前线程的偏向锁（**id的匹配**）。
如果测试成功，表示线程已经获取到了锁。如果测试失败，则需要再测试一下mark word
中偏向锁的标识是否设置成1（表示当前是偏向锁）；如果没有设置，则使用CAS竞争锁；如果设置了，则尝试使用CAS将对象头的

`偏向锁指向当前线程`:`CAS竞争，替换线程ID`。